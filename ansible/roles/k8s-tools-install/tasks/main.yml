---
# tasks/main.yml

#########################################
# Ensure necessary files are available
#########################################
- name: Debug versions data
  debug:
    var: k8s_tools

- name: Check if Helm tarball exists locally
  stat:
    path: '/root/offline_deploy/k8s-utils/helm-v3.12.0-linux-amd64.tar.gz'
  register: helm_tarball_stat
  become: yes

- name: Download Helm tarball if not present
  get_url:
    url: 'https://get.helm.sh/helm-v3.12.0-linux-amd64.tar.gz'
    dest: '/root/offline_deploy/k8s-utils/helm-v3.12.0-linux-amd64.tar.gz'
    mode: '0644'
  when: not helm_tarball_stat.stat.exists
  become: yes

- name: Check if k9s tarball exists locally
  stat:
    path: '/root/offline_deploy/k8s-utils/k9s_Linux_amd64.tar.gz'
  register: k9s_tarball_stat
  become: yes

- name: Download k9s tarball if not present
  get_url:
    url: 'https://github.com/derailed/k9s/releases/download/v0.27.3/k9s_Linux_amd64.tar.gz'
    dest: '/root/offline_deploy/k8s-utils/k9s_Linux_amd64.tar.gz'
    mode: '0644'
  when: not k9s_tarball_stat.stat.exists
  become: yes

- name: Check if Helmfile binary exists locally
  stat:
    path: '/root/offline_deploy/k8s-utils/helmfile_linux_amd64'
  register: helmfile_binary_stat
  become: yes

- name: Download Helmfile binary if not present
  get_url:
    url: 'https://github.com/roboll/helmfile/releases/download/v0.145.0/helmfile_linux_amd64'
    dest: '/root/offline_deploy/k8s-utils/helmfile_linux_amd64'
    mode: '0755'
  when: not helmfile_binary_stat.stat.exists
  become: yes

#########################################
# Create temporary directory for offline tools
#########################################

- name: Create temporary directory for offline tools
  file:
    path: /tmp/k8s-tools
    state: directory
    mode: '0755'
  become: yes

#########################################
# Install Helm Offline
#########################################

- name: Copy Helm tarball to temporary directory
  copy:
    src: '/root/offline_deploy/k8s-utils/helm-v3.12.0-linux-amd64.tar.gz'
    dest: /tmp/k8s-tools/helm-v3.12.0-linux-amd64.tar.gz
    mode: '0644'
  become: yes

- name: Extract Helm tarball
  unarchive:
    src: /tmp/k8s-tools/helm-v3.12.0-linux-amd64.tar.gz
    dest: /tmp/k8s-tools/
    remote_src: yes
  become: yes

- name: Install Helm binary
  copy:
    src: /tmp/k8s-tools/linux-amd64/helm
    dest: /usr/local/bin/helm
    mode: '0755'
    remote_src: yes
  become: yes

#########################################
# Install k9s Offline
#########################################

- name: Copy k9s tarball to temporary directory
  copy:
    src: '/root/offline_deploy/k8s-utils/k9s_Linux_amd64.tar.gz'
    dest: /tmp/k8s-tools/k9s_Linux_amd64.tar.gz
    mode: '0644'
  become: yes

- name: Extract k9s tarball
  unarchive:
    src: /tmp/k8s-tools/k9s_Linux_amd64.tar.gz
    dest: /tmp/k8s-tools/
    remote_src: yes
  become: yes

- name: Install k9s binary
  copy:
    src: /tmp/k8s-tools/k9s
    dest: /usr/local/bin/k9s
    mode: '0755'
    remote_src: yes
  become: yes

#########################################
# Install Helmfile Offline
#########################################

- name: Copy Helmfile binary to /usr/local/bin
  copy:
    src: '/root/offline_deploy/k8s-utils/helmfile_linux_amd64'
    dest: /usr/local/bin/helmfile
    mode: '0755'
  become: yes

#########################################
# Optional: Clean up temporary directory
#########################################

- name: Remove temporary directory
  file:
    path: /tmp/k8s-tools
    state: absent
  become: yes
