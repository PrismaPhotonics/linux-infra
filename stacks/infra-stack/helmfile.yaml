{{- $offlineDeploy := (env "OFFLINE_DEPLOY" | default "offline_deploy") -}}
{{- $thirdSubnetOctet := (env "THIRD_SUBNET_OCTET" | default "10") -}}
{{- $secondSubnetOctet := (env "SECOND_SUBNET_OCTET" | default "10") -}}
{{- $project_name := (env "PROJECT_NAME" | default "10") -}}

releases:
  - name: openebs
    namespace: openebs
    chart: /home/prisma/{{ $offlineDeploy }}/helm_charts/downloaded_helm_charts/openebs       # Local chart for OpenEBS
    wait: true
    timeout: 600
    values:
      - openebs/values.yml
    hooks:
      - events: ["postsync"]
        showlogs: true
        command: "kubectl"
        args: ["apply", "-f", "openebs/storageclass.yml"]      

  - name: ingress-nginx
    namespace: kube-system
    chart: /home/prisma/{{ $offlineDeploy }}/helm_charts/downloaded_helm_charts/ingress-nginx
    timeout: 600      
    hooks:
      - events: ["presync"]
        showlogs: true
        command: "bash"
        args: ["./scripts/create_tls.sh"]
      - events: ["postsync"]
        showlogs: true
        command: "bash"
        args:
          - "-c"
          - |
              echo "Waiting for ingress pods to appear..."
              until kubectl get pods -n kube-system -l app.kubernetes.io/name=ingress-nginx --no-headers | grep -q .; do
                sleep 1
              done
              echo "ingress pods detected. Waiting for them to be Ready..."
              kubectl wait --for=condition=Ready pod -n kube-system -l app.kubernetes.io/name=ingress-nginx --timeout=600s     
    values:
      - ingress-nginx/values.yml
      - controller:
          service:
            loadBalancerIP: "10.{{ $secondSubnetOctet }}.{{ $thirdSubnetOctet }}.100"
   

  - name: metallb
    namespace: metallb
    chart: /home/prisma/{{ $offlineDeploy }}/helm_charts/downloaded_helm_charts/metallb      
    wait: true
    timeout: 600  
    values:
      - metallb:
          addresses: 
          - "10.{{ $secondSubnetOctet }}.{{ $thirdSubnetOctet }}.100-10.{{ $secondSubnetOctet }}.{{ $thirdSubnetOctet }}.120"
          - "10.{{ $secondSubnetOctet }}.{{ $thirdSubnetOctet }}.50/32"

  - name: pihole
    namespace: pihole
    chart: /home/prisma/{{ $offlineDeploy }}/helm_charts/downloaded_helm_charts/pihole      
    timeout: 600
    hooks:
      - events: ["postsync"]
        showlogs: true
        command: "bash"
        args:
          - "-c"
          - |
              echo "Waiting for elastipiholecsearch pods to appear..."
              until kubectl get pods -n pihole -l release=pihole --no-headers | grep -q .; do
                sleep 1
              done
              echo "pihole pods detected. Waiting for them to be Ready..."
              kubectl wait --for=condition=Ready pod -n pihole -l release=pihole --timeout=600s
    values:
      - pihole/values.yml
      - serviceDns:
          loadBalancerIP: "10.{{ $secondSubnetOctet }}.{{ $thirdSubnetOctet }}.50"
        serviceWeb:
          loadBalancerIP: "10.{{ $secondSubnetOctet }}.{{ $thirdSubnetOctet }}.50"
      - pihole/projects/{{ $project_name }}/values.yml.gotmpl
    
